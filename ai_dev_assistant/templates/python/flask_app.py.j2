# {{ component.name }} - Generated by AI Dev Assistant

from flask import Flask, jsonify, send_file, url_for
import subprocess
import os

app = Flask(__name__)

@app.route('/')
def index():
    return """
    <h1>Welcome to {{ config.appName }}!</h1>
    <p>Click <a href="/api/sales_plot">here</a> to generate the sales plot.</p>
    """

@app.route('/api/sales_plot')
def generate_sales_plot():
    """
    Generates a sales plot using an R script.
    """
    try:
        # Assuming the R script is in the same directory
        result = subprocess.run(["Rscript", "plot_generator.R"], check=True, capture_output=True, text=True)
        plot_url = url_for('get_plot', _external=True)
        return jsonify({
            "status": "success",
            "message": "Plot generated successfully.",
            "plot_url": plot_url,
            "r_script_output": result.stdout
        })
    except subprocess.CalledProcessError as e:
        return jsonify({
            "status": "error",
            "message": "Error executing R script.",
            "stdout": e.stdout,
            "stderr": e.stderr
        }), 500
    except FileNotFoundError:
        return jsonify({"status": "error", "message": "Rscript not found. Is R installed and in the PATH?"}), 500

@app.route('/plot')
def get_plot():
    """
    Serves the generated plot image.
    """
    plot_path = "sales_plot.png"
    if os.path.exists(plot_path):
        return send_file(plot_path, mimetype='image/png')
    else:
        return "Plot not found. Please generate it first by visiting /api/sales_plot.", 404

if __name__ == '__main__':
    app.run(debug=True, port=5000)
